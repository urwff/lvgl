cmake_minimum_required(VERSION 3.20)

# é¡¹ç›®åç§°ä¸è¯­è¨€
project(smart_home C)
set(CMAKE_C_STANDARD 99)

# æ„å»ºç±»å‹ï¼šé»˜è®¤ä½¿ç”¨ Releaseï¼Œä¾¿äºæ¿ç«¯éƒ¨ç½²ï¼ˆå¯ç”¨ -DCMAKE_BUILD_TYPE=Debug åˆ‡æ¢ï¼‰
if(NOT CMAKE_BUILD_TYPE)
  set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif()

# å‹å¥½ç¼–è¯‘ä¿¡æ¯ï¼ˆé…ç½®é˜¶æ®µï¼‰
message(STATUS "[smart_home] Project: ${PROJECT_NAME}")
message(STATUS "[smart_home] Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "[smart_home] C compiler: ${CMAKE_C_COMPILER}")

# LVGL é…ç½®ï¼šè®© LVGL ä»¥ç®€åŒ–æ–¹å¼æ‰¾åˆ° config/lv_conf.h
# éœ€è¦ä½ çš„ config/lv_conf.h ç¬¬ä¸€è¡Œä¸º #if 1ï¼Œå¹¶ä¸ LV_CONF_INCLUDE_SIMPLE é…åˆ
set(LV_BUILD_CONF_PATH ${CMAKE_SOURCE_DIR}/config/lv_conf.h)
add_definitions(-DLV_CONF_INCLUDE_SIMPLE)

# å…³é—­ LVGL ç¤ºä¾‹/æ¼”ç¤ºï¼Œä¿æŒä¸å½“å‰ Makefile çš„æœ€å°ä¾èµ–ä¸€è‡´
set(CONFIG_LV_BUILD_DEMOS OFF CACHE BOOL "Build LVGL demos" FORCE)
set(CONFIG_LV_BUILD_EXAMPLES OFF CACHE BOOL "Build LVGL examples" FORCE)

# å¼•å…¥ LVGL æºç ï¼ˆå‡è®¾ä¸ºå®˜æ–¹ä»“åº“ç»“æ„ï¼‰
add_subdirectory(libs/lvgl)

# æ”¶é›†åº”ç”¨æºæ–‡ä»¶ï¼ˆä¸ç°æœ‰é¡¹ç›®å¸ƒå±€å¯¹é½ï¼‰
file(GLOB_RECURSE APP_SRC
  ${CMAKE_SOURCE_DIR}/src/*.c
  ${CMAKE_SOURCE_DIR}/src/core/*.c
  ${CMAKE_SOURCE_DIR}/src/service/*.c
  ${CMAKE_SOURCE_DIR}/src/ui/*.c
  ${CMAKE_SOURCE_DIR}/src/ui/components/*.c
  ${CMAKE_SOURCE_DIR}/src/ui/pages/*.c
  ${CMAKE_SOURCE_DIR}/src/utils/*.c
)

# ç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶
add_executable(smart_home_ui ${APP_SRC})

# å¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼ˆä¸ Make ç­‰æ•ˆï¼‰
target_include_directories(smart_home_ui PRIVATE
  ${CMAKE_SOURCE_DIR}
  ${CMAKE_SOURCE_DIR}/src
  ${CMAKE_SOURCE_DIR}/libs
  ${CMAKE_SOURCE_DIR}/libs/lvgl
)

# ç¼–è¯‘ä¸é“¾æ¥é€‰é¡¹ï¼ˆä¸ Make å¯¹é½ï¼Œå¹¶ç»™å‡ºå¯é€‰ä¼˜åŒ–ï¼‰
target_compile_options(smart_home_ui PRIVATE -Wall)
# å¯é€‰ï¼šç¼©å°ä½“ç§¯ï¼ˆæ¿ç«¯å­˜å‚¨ç´§å¼ æ—¶å¯ç”¨ï¼‰
# target_compile_options(smart_home_ui PRIVATE -Os -ffunction-sections -fdata-sections)
# target_link_options(smart_home_ui PRIVATE -Wl,--gc-sections)

# é“¾æ¥åº“ï¼šä¸ Make çš„ -lm -lpthread å¯¹é½
target_link_libraries(smart_home_ui PRIVATE lvgl m pthread)

# å…³é”®è·¯å¾„æç¤ºï¼ˆç¼–è¯‘é˜¶æ®µï¼‰
add_custom_target(_echo_build_info ALL
  COMMAND ${CMAKE_COMMAND} -E echo "\nğŸ§± æ­£åœ¨ç¼–è¯‘ smart_home_uiï¼ˆ${CMAKE_BUILD_TYPE}ï¼‰..."
  COMMAND ${CMAKE_COMMAND} -E echo "ğŸ“‚ æºç æ–‡ä»¶æ•°: $<LENGTH:${APP_SRC}>"
  VERBATIM
)
add_dependencies(_echo_build_info smart_home_ui)

# æ„å»ºå®Œæˆæç¤º
add_custom_command(TARGET smart_home_ui POST_BUILD
  COMMAND ${CMAKE_COMMAND} -E echo "\nâœ… æ„å»ºå®Œæˆ: $<TARGET_FILE:smart_home_ui>"
  COMMAND ${CMAKE_COMMAND} -E echo "ğŸ’¡ éƒ¨ç½²åˆ°å¼€å‘æ¿: scp $<TARGET_FILE:smart_home_ui> root@<board_ip>:/root/"
  COMMAND ${CMAKE_COMMAND} -E echo "â–¶ï¸  æ¿ä¸Šè¿è¡Œ: ./smart_home_ui"
  VERBATIM
)